import inspect

from .sync import iscoroutinefunction


def is_double_callable(application):
    """
    Tests to see if an application is a legacy-style (double-callable) application.
    """
    if getattr(application, "_asgi_single_callable", False):
        return False
    if getattr(application, "_asgi_double_callable", False):
        return True
    if inspect.isclass(application):
        return True
    if hasattr(application, "__call__"):
        if iscoroutinefunction(application.__call__):
            return False
    return not iscoroutinefunction(application)


def double_to_single_callable(application):
    async def new_application(scope, receive, send):
        instance = application(scope)
        return await instance(receive, send)
    return new_application


def guarantee_single_callable(application):
    if is_double_callable(application):
        application = double_to_single_callable(application)
    return application
